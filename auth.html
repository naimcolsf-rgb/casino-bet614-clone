<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Royale - Ruleta Digital</title>
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cargar Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos personalizados para un tema de casino lujoso y oscuro */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            background-image: radial-gradient(circle at center, #2d3748 0%, #1a202c 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.5s;
        }
        /* Clase para simular estado de carga/inactivo */
        .disabled-btn {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        
        /* Estilos espec铆ficos de la Ruleta */
        .wheel-container {
            width: 250px;
            height: 250px;
            position: relative;
            margin: 0 auto;
        }
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 10px solid gold;
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
            position: relative;
            background: conic-gradient(
                #ef4444 0% 1/37,  /* Rojo */
                #10b981 1/37 2/37,  /* Verde */
                #2563eb 2/37 3/37,  /* Azul */
                #f97316 3/37 4/37,  /* Naranja */
                #ef4444 4/37 5/37,
                #10b981 5/37 6/37,
                #2563eb 6/37 7/37,
                #f97316 7/37 8/37,
                #ef4444 8/37 9/37,
                #10b981 9/37 10/37,
                #2563eb 10/37 11/37,
                #f97316 11/37 12/37,
                #ef4444 12/37 13/37,
                #10b981 13/37 14/37,
                #2563eb 14/37 15/37,
                #f97316 15/37 16/37,
                #ef4444 16/37 17/37,
                #10b981 17/37 18/37,
                #2563eb 18/37 19/37,
                #f97316 19/37 20/37,
                #ef4444 20/37 21/37,
                #10b981 21/37 22/37,
                #2563eb 22/37 23/37,
                #f97316 23/37 24/37,
                #ef4444 24/37 25/37,
                #10b981 25/37 26/37,
                #2563eb 26/37 27/37,
                #f97316 27/37 28/37,
                #ef4444 28/37 29/37,
                #10b981 29/37 30/37,
                #2563eb 30/37 31/37,
                #f97316 31/37 32/37,
                #ef4444 32/37 33/37,
                #10b981 33/37 34/37,
                #2563eb 34/37 35/37,
                #f97316 35/37 36/37,
                #ef4444 36/37 100%
            );
        }
        .marker {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 15px solid #ff0000;
            filter: drop-shadow(0 0 5px #ff0000);
            z-index: 10;
        }

    </style>
</head>
<body>

    <!-- Contenedor principal de la aplicaci贸n -->
    <div class="w-full max-w-sm sm:max-w-md p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl transition-all duration-300">
        
        <!-- Mensaje de estado (茅xito/error) -->
        <div id="message-box" class="fixed top-0 left-0 right-0 p-4 text-center hidden z-50"></div>

        <!-- Vista de Autenticaci贸n (Inicialmente visible) -->
        <div id="auth-view" class="block">
            <div class="text-center mb-6">
                <span class="text-5xl text-yellow-500 mb-2">
                    <i class="fas fa-crown"></i>
                </span>
                <h1 class="text-3xl sm:text-4xl font-extrabold text-white tracking-wider">AUTENTICACIN</h1>
            </div>

            <!-- Tabs de Login/Registro -->
            <div class="flex border-b border-gray-700 mb-6 text-xl">
                <button id="show-login" class="flex-1 py-2 text-white border-b-2 border-yellow-500 font-semibold transition duration-200">Iniciar Sesi贸n</button>
                <button id="show-register" class="flex-1 py-2 text-gray-400 border-b-2 border-transparent hover:border-gray-600 font-semibold transition duration-200">Registrarse</button>
            </div>

            <!-- Formulario de LOGIN -->
            <form id="login-form" class="space-y-4">
                <p class="text-center text-gray-400 -mt-4">Inicia Sesi贸n para Jugar</p>
                <div>
                    <input type="email" id="login-email" placeholder="Correo Electr贸nico" required
                           class="w-full px-4 py-3 bg-gray-700 text-white rounded-xl focus:ring-yellow-500 focus:border-yellow-500 border-gray-600 transition">
                </div>
                <div>
                    <input type="password" id="login-password" placeholder="Contrase帽a" required minlength="6"
                           class="w-full px-4 py-3 bg-gray-700 text-white rounded-xl focus:ring-yellow-500 focus:border-yellow-500 border-gray-600 transition">
                </div>
                <button type="submit" id="login-btn" 
                        class="w-full flex items-center justify-center py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg shadow-green-900/50 transition duration-150 disabled-btn" disabled>
                    <i class="fas fa-arrow-right mr-2 mt-1"></i> Iniciar Sesi贸n
                </button>
                <p class="text-center text-sm mt-3">
                    驴No tienes una cuenta? <span id="toggle-register-link" class="text-yellow-500 hover:text-yellow-400 cursor-pointer" onclick="toggleAuthView(true)">Reg铆strate</span>
                </p>
            </form>

            <!-- Formulario de REGISTRO (Inicialmente oculto) -->
            <form id="register-form" class="space-y-4 hidden">
                <p class="text-center text-gray-400 -mt-4">Crea Tu Cuenta</p>
                <div>
                    <input type="text" id="register-username" placeholder="Nombre de Usuario" required
                           class="w-full px-4 py-3 bg-gray-700 text-white rounded-xl focus:ring-red-500 focus:border-red-500 border-gray-600 transition">
                </div>
                <div>
                    <input type="email" id="register-email" placeholder="Correo Electr贸nico" required
                           class="w-full px-4 py-3 bg-gray-700 text-white rounded-xl focus:ring-red-500 focus:border-red-500 border-gray-600 transition">
                </div>
                <div>
                    <input type="password" id="register-password" placeholder="Contrase帽a" required minlength="6"
                           class="w-full px-4 py-3 bg-gray-700 text-white rounded-xl focus:ring-red-500 focus:border-red-500 border-gray-600 transition">
                </div>
                <div>
                    <input type="text" id="register-dni" placeholder="DNI (Opcional)"
                           class="w-full px-4 py-3 bg-gray-700 text-white rounded-xl focus:ring-red-500 focus:border-red-500 border-gray-600 transition">
                </div>
                <button type="submit" id="register-btn"
                        class="w-full flex items-center justify-center py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg shadow-red-900/50 transition duration-150 disabled-btn" disabled>
                    <i class="fas fa-user-plus mr-2 mt-1"></i> Registrarse
                </button>
                <p class="text-center text-sm mt-3">
                    驴Ya tienes una cuenta? <span id="toggle-login-link" class="text-yellow-500 hover:text-yellow-400 cursor-pointer" onclick="toggleAuthView(false)">Inicia Sesi贸n</span>
                </p>
            </form>
            
        </div>
        
        <!-- Vista del Dashboard/Casino (Inicialmente oculto) -->
        <div id="dashboard-view" class="hidden">
            <div class="text-center mb-6">
                <h1 id="welcome-message" class="text-2xl sm:text-3xl font-extrabold text-white tracking-wider mb-2"></h1>
                <div class="p-4 bg-yellow-900/30 rounded-xl shadow-lg inline-block">
                    <p class="text-yellow-400 text-sm font-semibold">SALDO ACTUAL:</p>
                    <p id="current-balance" class="text-4xl font-extrabold text-yellow-500">$0.00</p>
                </div>
                <!-- Muestra el User ID -->
                <div id="user-id-container" class="mt-4 hidden text-xs text-gray-500">
                    ID Usuario: <span id="current-user-id" class="font-mono text-gray-400"></span>
                </div>
            </div>

            <!-- Controles de la Ruleta -->
            <div class="p-6 bg-gray-900 rounded-xl shadow-inner shadow-black/50 mb-6">
                <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2"> Ruleta Digital</h2>
                
                <div class="wheel-container mb-4">
                    <div class="marker"></div>
                    <div id="roulette-wheel" class="wheel"></div>
                </div>

                <div class="flex space-x-2 mb-4">
                    <input type="number" id="bet-amount" value="10" min="1" step="1"
                           class="w-1/3 px-3 py-2 bg-gray-700 text-white rounded-xl focus:ring-yellow-500 focus:border-yellow-500 transition"
                           placeholder="Apuesta">
                    <select id="bet-type"
                            class="w-2/3 px-3 py-2 bg-gray-700 text-white rounded-xl focus:ring-yellow-500 focus:border-yellow-500 transition">
                        <option value="red">Rojo (x2)</option>
                        <option value="black">Negro (x2)</option>
                        <option value="green">Verde (x35)</option>
                    </select>
                </div>

                <button id="spin-btn" 
                        class="w-full flex items-center justify-center py-3 bg-red-700 hover:bg-red-800 text-white font-bold rounded-xl shadow-lg shadow-red-900/50 transition duration-150">
                    <i class="fas fa-hand-point-up mr-2 mt-1"></i> 隆Girar Ruleta!
                </button>
            </div>

            <!-- Bot贸n de Salir -->
            <button id="logout-btn" 
                    class="w-full flex items-center justify-center py-2 text-sm bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-xl transition mt-4">
                <i class="fas fa-sign-out-alt mr-2 mt-1"></i> Salir
            </button>
        </div>

    </div>

    <!-- Script de Firebase (Importaci贸n) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug'); // Ver logs de Firestore

        // --- Variables Globales Proporcionadas por el Entorno ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-casino-app';
        let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        // **CRTICO: Configuraci贸n de Respaldo si no se cargan las variables del entorno**
        if (!Object.keys(firebaseConfig).length) {
            console.warn("ADVERTENCIA: Usando configuraci贸n de Firebase de respaldo (simulada) para forzar la inicializaci贸n.");
            firebaseConfig = {
                apiKey: "AIzaSimulatedKey",
                authDomain: "simulated-domain.firebaseapp.com",
                projectId: "simulated-project",
                storageBucket: "simulated-bucket.appspot.com",
                messagingSenderId: "1234567890",
                appId: "1:1234567890:web:simulatedapp"
            };
        }

        // --- Referencias de Firestore ---
        let db, auth;
        let userId = null;
        const USERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/users`;

        // --- Referencias al DOM ---
        const authView = document.getElementById('auth-view');
        const dashboardView = document.getElementById('dashboard-view');
        const showLoginBtn = document.getElementById('show-login');
        const showRegisterBtn = document.getElementById('show-register');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const currentBalanceEl = document.getElementById('current-balance');
        const welcomeMessageEl = document.getElementById('welcome-message');
        const messageBox = document.getElementById('message-box');
        const currentUserIdDisplay = document.getElementById('current-user-id');
        const userIdContainer = document.getElementById('user-id-container');
        const rouletteWheel = document.getElementById('roulette-wheel');
        const spinBtn = document.getElementById('spin-btn');
        const betAmountInput = document.getElementById('bet-amount');
        const betTypeSelect = document.getElementById('bet-type');

        // --- Funciones Utilitarias ---

        // Muestra un mensaje temporal en la parte superior
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `fixed top-0 left-0 right-0 p-4 text-center z-50 transition-colors duration-300`;

            if (type === 'error') {
                messageBox.classList.add('bg-red-700', 'text-white', 'block');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-600', 'text-white', 'block');
            } else {
                messageBox.classList.add('bg-blue-600', 'text-white', 'block');
            }

            setTimeout(() => {
                messageBox.classList.replace('block', 'hidden');
            }, 5000);
        }

        // Alterna entre la vista de Login y Registro
        function toggleAuthView(isRegister = false) {
            if (isRegister) {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                showLoginBtn.classList.replace('border-yellow-500', 'border-transparent');
                showLoginBtn.classList.replace('text-white', 'text-gray-400');
                showRegisterBtn.classList.replace('border-transparent', 'border-red-500');
                showRegisterBtn.classList.replace('text-gray-400', 'text-white');
            } else {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                showRegisterBtn.classList.replace('border-red-500', 'border-transparent');
                showRegisterBtn.classList.replace('text-white', 'text-gray-400');
                showLoginBtn.classList.replace('border-transparent', 'border-yellow-500');
                showLoginBtn.classList.replace('text-gray-400', 'text-white');
            }
        }

        // Alterna entre la vista de Autenticaci贸n y el Dashboard
        function switchView(toDashboard) {
            if (toDashboard) {
                authView.classList.replace('block', 'hidden');
                dashboardView.classList.replace('hidden', 'block');
            } else {
                dashboardView.classList.replace('block', 'hidden');
                authView.classList.replace('hidden', 'block');
                toggleAuthView(false); // Volver a la vista de Login por defecto
            }
        }

        // --- Funciones de Firestore y L贸gica de Negocio ---

        // Escucha cambios en el saldo del usuario en tiempo real
        function startBalanceListener(email) {
            const userDocRef = doc(db, USERS_COLLECTION_PATH, email);

            // onSnapshot se mantiene escuchando los cambios
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const balance = userData.balance || 0;
                    currentBalanceEl.textContent = `$${balance.toFixed(2)}`;
                    welcomeMessageEl.textContent = `隆Hola, ${userData.username || 'Jugador'}!`;
                    console.log("Saldo actualizado en tiempo real:", balance);
                } else {
                    console.log("El documento del usuario ya no existe.");
                }
            }, (error) => {
                console.error("Error al escuchar cambios del saldo:", error);
                showMessage(`Error de conexi贸n al balance: ${error.message}`, 'error');
            });
        }

        // Actualiza el saldo en la base de datos
        async function updateBalance(email, amount) {
            if (!db) {
                showMessage("La base de datos no est谩 inicializada.", 'error');
                return;
            }

            const userDocRef = doc(db, USERS_COLLECTION_PATH, email);
            try {
                // Obtener el saldo actual para asegurar una actualizaci贸n precisa
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) {
                    showMessage("Error: No se encontr贸 el documento del usuario para actualizar el saldo.", 'error');
                    return false;
                }
                
                const currentBalance = docSnap.data().balance || 0;
                const newBalance = currentBalance + amount;
                
                if (newBalance < 0) {
                    showMessage("隆Saldo insuficiente para esta apuesta!", 'error');
                    return false;
                }

                await updateDoc(userDocRef, {
                    balance: newBalance
                });

                // La actualizaci贸n en la UI la maneja autom谩ticamente startBalanceListener
                return true;

            } catch (error) {
                console.error("Error al actualizar el saldo:", error);
                showMessage(`Error al actualizar saldo: ${error.message}`, 'error');
                return false;
            }
        }

        // Simula el proceso de registro
        async function registerUser(username, email, password, dni) {
            if (!db) {
                showMessage("La base de datos no est谩 inicializada.", 'error');
                return false;
            }
            if (!auth.currentUser) {
                showMessage("Error de autenticaci贸n. Intenta recargar la p谩gina.", 'error');
                return false;
            }
            
            const userDocRef = doc(db, USERS_COLLECTION_PATH, email);
            
            try {
                // 1. Verificar si el usuario ya existe
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    showMessage("El correo electr贸nico ya est谩 registrado. Intenta iniciar sesi贸n.", 'error');
                    return false;
                }

                // 2. Crear el nuevo documento de usuario
                const initialBalance = 1000;
                await setDoc(userDocRef, {
                    username: username,
                    email: email,
                    // NOTA: La contrase帽a no se almacena en Firestore. Se almacena solo para simulaci贸n.
                    // En un entorno real, Firebase Auth manejar铆a esto.
                    password_hash_simulated: password.length, 
                    dni: dni,
                    balance: initialBalance,
                    createdAt: new Date().toISOString(),
                    userId: auth.currentUser.uid // Usamos el ID de la autenticaci贸n an贸nima
                });

                // 3. Iniciar la escucha del saldo y cambiar la vista
                startBalanceListener(email);
                switchView(true);
                showMessage("隆Registro exitoso! Bienvenido al Casino.", 'success');
                return true;

            } catch (error) {
                console.error("Error al registrar el usuario en Firestore:", error);
                showMessage(`Error de registro: ${error.message}`, 'error');
                return false;
            }
        }

        // Simula el proceso de inicio de sesi贸n
        async function loginUser(email, password) {
            if (!db) {
                showMessage("La base de datos no est谩 inicializada.", 'error');
                return;
            }

            const userDocRef = doc(db, USERS_COLLECTION_PATH, email);
            try {
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    
                    // Simulaci贸n de verificaci贸n de contrase帽a (en la vida real usar铆as Firebase Auth)
                    if (userData.password_hash_simulated !== password.length) {
                         showMessage("Contrase帽a incorrecta.", 'error');
                         return;
                    }

                    // Iniciar la escucha del saldo y cambiar la vista
                    startBalanceListener(email);
                    switchView(true);
                    showMessage(`隆Bienvenido de vuelta, ${userData.username}!`, 'success');

                } else {
                    showMessage("Usuario no encontrado. Por favor reg铆strate.", 'error');
                }
            } catch (error) {
                console.error("Error durante el inicio de sesi贸n:", error);
                showMessage(`Error de inicio de sesi贸n: ${error.message}`, 'error');
            }
        }

        // --- L贸gica de Ruleta ---

        const colors = [
            'green', 'red', 'black', 'red', 'black', 'red', 'black', 'red', 'black', 'red', 'black',
            'red', 'black', 'red', 'black', 'red', 'black', 'red', 'black', 'red', 'black',
            'red', 'black', 'red', 'black', 'red', 'black', 'red', 'black', 'red', 'black',
            'red', 'black', 'red', 'black', 'red', 'black', 'red'
        ];
        
        // Mapea el color con el factor de ganancia
        const winMultipliers = {
            'green': 35,
            'red': 2,
            'black': 2
        };

        const resultColorMap = {
             0: 'green', 1: 'red', 2: 'black', 3: 'red', 4: 'black', 5: 'red', 6: 'black',
             7: 'red', 8: 'black', 9: 'red', 10: 'black', 11: 'red', 12: 'black',
             13: 'red', 14: 'black', 15: 'red', 16: 'black', 17: 'red', 18: 'black',
             19: 'red', 20: 'black', 21: 'red', 22: 'black', 23: 'red', 24: 'black',
             25: 'red', 26: 'black', 27: 'red', 28: 'black', 29: 'red', 30: 'black',
             31: 'red', 32: 'black', 33: 'red', 34: 'black', 35: 'red', 36: 'black',
             37: 'green' // 37 no se usa, pero por si acaso.
        };

        function calculateWinnings(betType, betAmount, winningNumber) {
            const winningColor = resultColorMap[winningNumber % 37]; // 0-36
            
            if (betType === winningColor) {
                const multiplier = winMultipliers[betType];
                return betAmount * multiplier; // Retorna la ganancia total
            }
            return 0; // P茅rdida
        }

        async function spinRoulette() {
            spinBtn.disabled = true;
            spinBtn.classList.add('disabled-btn');

            const betAmount = parseFloat(betAmountInput.value);
            const betType = betTypeSelect.value;
            const currentBalanceText = currentBalanceEl.textContent.replace('$', '');
            const currentBalance = parseFloat(currentBalanceText);
            const userEmail = document.getElementById('login-email').value || document.getElementById('register-email').value;

            if (isNaN(betAmount) || betAmount <= 0) {
                showMessage("La cantidad de la apuesta debe ser un n煤mero positivo.", 'error');
                spinBtn.disabled = false;
                spinBtn.classList.remove('disabled-btn');
                return;
            }

            if (betAmount > currentBalance) {
                showMessage("隆Saldo insuficiente para apostar esa cantidad!", 'error');
                spinBtn.disabled = false;
                spinBtn.classList.remove('disabled-btn');
                return;
            }

            // 1. Descontar la apuesta inmediatamente
            const deductionSuccess = await updateBalance(userEmail, -betAmount);
            if (!deductionSuccess) {
                 spinBtn.disabled = false;
                 spinBtn.classList.remove('disabled-btn');
                 return;
            }

            // 2. L贸gica de Giro
            const winningNumber = Math.floor(Math.random() * 37); // 0 a 36
            const winningColor = resultColorMap[winningNumber];
            
            // Cada n煤mero ocupa 360/37 grados. Queremos que el marcador apunte al centro del sector.
            // Posici贸n final (grados): el n煤mero ganador est谩 en un sector. Multiplicamos su 铆ndice por 360/37.
            // A帽adimos muchas vueltas (7-10 vueltas completas) para el efecto visual.
            const sectorAngle = 360 / 37;
            const rotationDegrees = (360 * 8) + (360 - (winningNumber * sectorAngle + sectorAngle / 2));
            
            // 3. Aplicar rotaci贸n y esperar
            rouletteWheel.style.transition = 'transform 6s cubic-bezier(0.25, 0.1, 0.25, 1)';
            rouletteWheel.style.transform = `rotate(${rotationDegrees}deg)`;

            // Esperar a que termine la animaci贸n
            setTimeout(async () => {
                // 4. Calcular ganancias
                const winnings = calculateWinnings(betType, betAmount, winningNumber);

                if (winnings > 0) {
                    // Si gana, sumamos la ganancia (que incluye la apuesta inicial)
                    const profit = winnings - betAmount;
                    await updateBalance(userEmail, profit);
                    showMessage(`隆GANASTE! Cay贸 en el ${winningNumber} (${winningColor}). Ganancia: $${profit.toFixed(2)}`, 'success');
                } else {
                    // Si pierde, la apuesta ya fue deducida
                    showMessage(`PERDISTE. Cay贸 en el ${winningNumber} (${winningColor}).`, 'error');
                }

                // 5. Restablecer el bot贸n y la rotaci贸n visual
                spinBtn.disabled = false;
                spinBtn.classList.remove('disabled-btn');
                
                // Resetear la transici贸n para que el pr贸ximo giro sea suave
                rouletteWheel.style.transition = 'none';
                // Dejar la ruleta en un 谩ngulo para que parezca que "termin贸"
                rouletteWheel.style.transform = `rotate(${rotationDegrees % 360}deg)`; 

            }, 6500); // 6.5 segundos para la animaci贸n
        }

        // --- FIREBASE: Inicializaci贸n y Autenticaci贸n ---
        
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Forzamos la autenticaci贸n an贸nima para obtener un ID de usuario
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        currentUserIdDisplay.textContent = userId;
                        userIdContainer.classList.remove('hidden');
                    } else {
                        userId = null;
                        currentUserIdDisplay.textContent = 'No autenticado';
                        if (dashboardView.classList.contains('block')) {
                            switchView(false);
                        }
                    }
                });

                // Habilitar botones de autenticaci贸n SOLO SI HAY XITO EN LA INICIALIZACIN
                loginBtn.disabled = false;
                loginBtn.classList.remove('disabled-btn');
                registerBtn.disabled = false;
                registerBtn.classList.remove('disabled-btn');
                
                if (firebaseConfig.projectId === "simulated-project") {
                    showMessage("Advertencia: Conectado en modo de RESPALDO. Por favor, reg铆strese/inicie sesi贸n para usar Firestore.", 'error');
                } else {
                    showMessage("Sistema listo. Puedes iniciar sesi贸n o registrarte.", 'success');
                }


            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                
                // ********* CORRECCIN CRTICA APLICADA *********
                // Habilitamos los botones incluso si la conexi贸n falla para poder probar la l贸gica del formulario
                loginBtn.disabled = false;
                loginBtn.classList.remove('disabled-btn');
                registerBtn.disabled = false;
                registerBtn.classList.remove('disabled-btn');
                // ***********************************************
                
                showMessage(`Error de configuraci贸n FINAL: ${error.name}: ${error.message}. Los botones est谩n activos para prueba.`, 'error');
            }
        }

        // --- Manejadores de Eventos de Autenticaci贸n y Ruleta ---

        // Alterna entre Iniciar Sesi贸n y Registrarse
        showLoginBtn.addEventListener('click', () => toggleAuthView(false));
        showRegisterBtn.addEventListener('click', () => toggleAuthView(true));

        // Formulario de REGISTRO
        registerForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const btn = registerBtn;
            
            // 1. Deshabilitar inmediatamente el bot贸n
            btn.disabled = true;
            btn.classList.add('disabled-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 mt-1"></i> Registrando...';

            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const dni = document.getElementById('register-dni').value; // Usamos DNI aqu铆
            
            try {
                if (password.length < 6) {
                    showMessage('La contrase帽a debe tener al menos 6 caracteres.', 'error');
                    return; 
                }
                
                // 2. Intentar el registro en Firestore
                const success = await registerUser(username, email, password, dni);

                if (success) {
                    // Si es exitoso, loginUser ya cambi贸 la vista y la escucha est谩 activa.
                }
            } catch (error) {
                console.error("Error durante el proceso de registro:", error);
                showMessage(`Error desconocido: ${error.message}`, 'error');
            } finally {
                // 3. Restaurar el bot贸n SIEMPRE al final
                btn.disabled = false;
                btn.classList.remove('disabled-btn');
                btn.innerHTML = '<i class="fas fa-user-plus mr-2 mt-1"></i> Registrarse';
            }
        });

        // Formulario de LOGIN
        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const btn = loginBtn;
            
            btn.disabled = true;
            btn.classList.add('disabled-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 mt-1"></i> Iniciando...';

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            await loginUser(email, password);
            
            // Restaurar el bot贸n
            btn.disabled = false;
            btn.classList.remove('disabled-btn');
            btn.innerHTML = '<i class="fas fa-arrow-right mr-2 mt-1"></i> Iniciar Sesi贸n';
        });
        
        // Botones de Dashboard
        spinBtn.addEventListener('click', spinRoulette);

        document.getElementById('logout-btn').addEventListener('click', () => {
             // Simulaci贸n de cierre de sesi贸n: solo cambia la vista
             switchView(false);
             showMessage("Sesi贸n cerrada. 隆Vuelve pronto!", 'info');
        });

        // Iniciar Firebase al cargar el script
        initializeFirebase();

    </script>
</body>
</html>