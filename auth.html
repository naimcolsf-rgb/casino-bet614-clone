<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Royale - Dashboard</title>
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos personalizados para un tema de casino lujoso y oscuro */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            background-image: radial-gradient(circle at center, #2d3748 0%, #1a202c 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.5s;
        }
        /* Clase para simular estado de carga/inactivo */
        .disabled-btn {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="p-4">

    <!-- Contenedor Principal de la Aplicaci贸n -->
    <div id="app-container" class="w-full max-w-4xl bg-gray-800 p-8 md:p-10 rounded-xl shadow-2xl transition-all duration-300 border-t-4 border-yellow-600">

        <!-- Caja de Mensajes de Estado (Global) -->
        <div id="message-box" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-center font-semibold z-50 min-w-[300px] transition-all duration-300" role="alert">
            <!-- Los mensajes se muestran aqu铆 -->
        </div>
        
        <!-- ============================================== -->
        <!-- 1. VISTA DE AUTENTICACIN (Inicio de Sesi贸n/Registro) -->
        <!-- ============================================== -->
        <div id="auth-view" class="transition-opacity duration-500 opacity-100 block">
             <div class="text-center mb-8">
                <i class="fas fa-crown text-4xl text-yellow-500 mb-2 animate-pulse"></i>
                <h1 class="text-3xl font-extrabold text-white tracking-wider">
                    AUTENTICACIN
                </h1>
                <p id="auth-title" class="text-yellow-400 text-lg mt-2 font-medium">Iniciar Sesi贸n para Jugar</p>
            </div>
            
            <!-- ID de Usuario (Para demostraci贸n de Firestore) -->
            <p id="user-id-display" class="text-center text-xs text-gray-400 mb-4 hidden">
                ID de Sesi贸n: <span id="current-user-id" class="font-mono text-yellow-500 break-all">...</span>
            </p>

            <!-- Formulario de Inicio de Sesi贸n -->
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-300">Correo Electr贸nico</label>
                    <div class="mt-1">
                        <input id="login-email" name="email" type="email" required autocomplete="email"
                            class="appearance-none block w-full px-4 py-2 border border-gray-600 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white transition duration-150 ease-in-out sm:text-sm">
                    </div>
                </div>

                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-300">Contrase帽a</label>
                    <div class="mt-1">
                        <input id="login-password" name="password" type="password" required autocomplete="current-password"
                            class="appearance-none block w-full px-4 py-2 border border-gray-600 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white transition duration-150 ease-in-out sm:text-sm">
                    </div>
                </div>

                <div>
                    <button id="login-btn" type="submit"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-lg text-base font-bold text-gray-900 bg-yellow-500 hover:bg-yellow-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition duration-150 ease-in-out transform hover:scale-[1.02]">
                        <i class="fas fa-sign-in-alt mr-2 mt-1"></i>
                        Iniciar Sesi贸n
                    </button>
                </div>
            </form>

            <!-- Formulario de Registro (Inicialmente oculto) -->
            <form id="register-form" class="space-y-6 hidden">
                <div>
                    <label for="register-username" class="block text-sm font-medium text-gray-300">Nombre de Usuario</label>
                    <div class="mt-1">
                        <input id="register-username" name="username" type="text" required autocomplete="username"
                            class="appearance-none block w-full px-4 py-2 border border-gray-600 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white transition duration-150 ease-in-out sm:text-sm">
                    </div>
                </div>

                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-300">Correo Electr贸nico</label>
                    <div class="mt-1">
                        <input id="register-email" name="email" type="email" required autocomplete="email"
                            class="appearance-none block w-full px-4 py-2 border border-gray-600 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white transition duration-150 ease-in-out sm:text-sm">
                    </div>
                </div>

                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-300">Contrase帽a</label>
                    <div class="mt-1">
                        <input id="register-password" name="password" type="password" required autocomplete="new-password"
                            class="appearance-none block w-full px-4 py-2 border border-gray-600 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-gray-700 text-white transition duration-150 ease-in-out sm:text-sm">
                    </div>
                </div>

                <div>
                    <button id="register-btn" type="submit"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-lg text-base font-bold text-gray-900 bg-red-600 hover:bg-red-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-600 transition duration-150 ease-in-out transform hover:scale-[1.02]">
                        <i class="fas fa-user-plus mr-2 mt-1"></i>
                        Registrarse
                    </button>
                </div>
            </form>

            <!-- Enlace para cambiar de vista -->
            <p class="mt-6 text-center text-sm text-gray-400">
                <button id="toggle-auth-link" class="font-medium text-yellow-500 hover:text-yellow-400 focus:outline-none">
                    驴No tienes una cuenta? Reg铆strate
                </button>
            </p>
        </div>

        <!-- ============================================== -->
        <!-- 2. VISTA DEL DASHBOARD (Juego) -->
        <!-- ============================================== -->
        <div id="dashboard-view" class="transition-opacity duration-500 opacity-0 hidden">
            <header class="flex justify-between items-center pb-6 border-b border-gray-700 mb-6">
                <h2 class="text-3xl font-extrabold text-white">
                    Bienvenido, <span id="display-username" class="text-yellow-400">Jugador</span>
                </h2>
                <button id="logout-btn" class="text-sm text-red-400 hover:text-red-300 transition duration-150">
                    <i class="fas fa-sign-out-alt mr-1"></i> Cerrar Sesi贸n
                </button>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Tarjeta de Saldo (Real-Time Data) -->
                <div class="md:col-span-1 bg-gray-700 p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                    <p class="text-sm font-medium text-gray-300">SALDO ACTUAL</p>
                    <div class="flex items-center mt-2">
                        <i class="fas fa-coins text-3xl text-yellow-500 mr-3"></i>
                        <span id="display-balance" class="text-4xl font-bold text-white tracking-wide">
                            $0.00
                        </span>
                    </div>
                    <p class="text-xs mt-2 text-gray-400">El saldo se actualiza en tiempo real.</p>
                </div>

                <!-- Contenedor del Juego (Simulaci贸n) -->
                <div class="md:col-span-2 bg-gray-900 p-6 rounded-xl shadow-inner border border-gray-700 flex flex-col justify-center items-center">
                    <h3 class="text-2xl font-semibold text-white mb-4">隆Elige tu Juego!</h3>
                    <p class="text-gray-400 mb-6 text-center">Aqu铆 integraremos la Ruleta, BlackJack o M谩quinas Tragamonedas.</p>
                    
                    <button id="simulate-game-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-500 transition duration-150 transform hover:scale-[1.05] shadow-lg disabled-btn" disabled>
                        <i class="fas fa-dice mr-2"></i> Simular Juego (-$10)
                    </button>
                    
                    <button id="simulate-deposit-btn" class="mt-4 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500 transition duration-150">
                        <i class="fas fa-plus-circle mr-2"></i> Simular Dep贸sito (+$50)
                    </button>
                </div>
            </div>
            
            <p class="text-xs text-center text-gray-600 mt-8">Nota: Los datos de usuario se guardan en la colecci贸n p煤blica de Firestore.</p>
        </div>

    </div>

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, query, where, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variables Globales Proporcionadas por el Entorno ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-casino-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        // Referencias a elementos del DOM
        const authView = document.getElementById('auth-view');
        const dashboardView = document.getElementById('dashboard-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const toggleLink = document.getElementById('toggle-auth-link');
        const authTitle = document.getElementById('auth-title');
        const messageBox = document.getElementById('message-box');
        const currentUserIdDisplay = document.getElementById('current-user-id');
        const userIdContainer = document.getElementById('user-id-display');
        
        // Elementos del Dashboard
        const displayUsername = document.getElementById('display-username');
        const displayBalance = document.getElementById('display-balance');
        const logoutBtn = document.getElementById('logout-btn');
        const simulateGameBtn = document.getElementById('simulate-game-btn');
        const simulateDepositBtn = document.getElementById('simulate-deposit-btn');

        let isLoginView = true;
        let db;
        let auth;
        let userId = null;
        let userEmail = null; // Necesario para identificar el documento en Firestore
        let unsubscribeBalance = null; // Para detener la escucha en tiempo real de Firestore

        // Ruta base para los datos de la colecci贸n de 'usuarios'
        const USERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/users`;

        // --- UTILS: Funciones de Interfaz de Usuario ---

        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-900', 'text-red-300', 'bg-green-900', 'text-green-300', 'bg-yellow-900', 'text-yellow-300');
            
            if (type === 'error') {
                messageBox.classList.add('bg-red-900', 'text-red-300');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-900', 'text-green-300');
            } else { // info
                messageBox.classList.add('bg-yellow-900', 'text-yellow-300');
            }
            messageBox.style.top = '4px'; // Asegura que est茅 visible
            setTimeout(() => {
                messageBox.classList.add('hidden');
                messageBox.style.top = '-50px';
            }, 5000);
        }

        function toggleAuthView() {
            isLoginView = !isLoginView;
            if (isLoginView) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                authTitle.textContent = 'Iniciar Sesi贸n para Jugar';
                toggleLink.innerHTML = "驴No tienes una cuenta? Reg铆strate";
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                authTitle.textContent = 'Crea Tu Cuenta';
                toggleLink.innerHTML = "驴Ya tienes una cuenta? Inicia Sesi贸n";
            }
        }
        
        // Funci贸n para cambiar de vista (Auth <-> Dashboard)
        function switchView(showDashboard) {
            if (showDashboard) {
                authView.classList.remove('opacity-100', 'block');
                authView.classList.add('opacity-0', 'hidden');
                
                setTimeout(() => {
                    dashboardView.classList.remove('opacity-0', 'hidden');
                    dashboardView.classList.add('opacity-100', 'block');
                }, 500); // Espera la transici贸n de opacidad
            } else {
                dashboardView.classList.remove('opacity-100', 'block');
                dashboardView.classList.add('opacity-0', 'hidden');
                
                setTimeout(() => {
                    authView.classList.remove('opacity-0', 'hidden');
                    authView.classList.add('opacity-100', 'block');
                }, 500); // Espera la transici贸n de opacidad
            }
        }

        // --- FIREBASE: Inicializaci贸n y Autenticaci贸n ---
        
        async function initializeFirebase() {
            try {
                if (!Object.keys(firebaseConfig).length) {
                    console.error("Firebase Config no est谩 disponible.");
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        currentUserIdDisplay.textContent = userId;
                        userIdContainer.classList.remove('hidden');
                    } else {
                        userId = null;
                        currentUserIdDisplay.textContent = 'No autenticado';
                    }
                });

                // Habilitar botones una vez que Firebase est茅 listo
                document.getElementById('login-btn').disabled = false;
                document.getElementById('register-btn').disabled = false;

            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                showMessage(`Error de configuraci贸n: ${error.message}`, 'error');
            }
        }
        
        // --- FIRESTORE: Funciones de Guardar y Cargar Datos ---
        
        /**
         *  FUNCIN CRUCIAL: Escucha cambios en tiempo real del saldo.
         * @param {string} email - Email del usuario (ID del documento).
         */
        function startBalanceListener(email) {
            // Si ya hay un listener activo, lo detenemos primero
            if (unsubscribeBalance) {
                unsubscribeBalance();
            }

            const userDocRef = doc(db, USERS_COLLECTION_PATH, email);

            // onSnapshot crea una conexi贸n en tiempo real
            unsubscribeBalance = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const newBalance = (data.balance || 0).toFixed(2);
                    displayBalance.textContent = `$${newBalance}`;
                    displayUsername.textContent = data.username || 'Jugador';
                    
                    // Habilitar bot贸n de juego si hay saldo suficiente
                    simulateGameBtn.disabled = data.balance < 10;
                    simulateGameBtn.classList.toggle('disabled-btn', data.balance < 10);
                    
                } else {
                    console.log("Documento de usuario no encontrado despu茅s del inicio de sesi贸n.");
                    showMessage("Error al cargar los datos en tiempo real.", 'error');
                }
            }, (error) => {
                console.error("Error al escuchar cambios en el saldo:", error);
                showMessage(`Error de conexi贸n: ${error.message}`, 'error');
            });
        }
        
        /**
         * Simula el registro: Crea un documento de usuario en Firestore.
         */
        async function registerUser(username, email, password) {
            if (!db || !userId) return showMessage('Sistema no listo.', 'error');
            try {
                const usersRef = collection(db, USERS_COLLECTION_PATH);
                const q = query(usersRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showMessage('El correo electr贸nico ya est谩 registrado.', 'error');
                    return false;
                }

                const userDocRef = doc(db, USERS_COLLECTION_PATH, email);
                const userData = {
                    username: username,
                    email: email,
                    // NOTA: Contrase帽a solo para simulaci贸n de validaci贸n
                    simulatedPasswordHash: password.length, 
                    balance: 1000.00, // Saldo inicial con decimales
                    creationDate: new Date().toISOString(),
                };

                await setDoc(userDocRef, userData);
                showMessage(`隆Registro exitoso para ${username}! Saldo inicial: $1000.00`, 'success');
                return true;

            } catch (error) {
                console.error("Error al registrar el usuario en Firestore:", error);
                showMessage(`Error de registro: ${error.message}`, 'error');
                return false;
            }
        }

        /**
         * Simula el inicio de sesi贸n: Carga los datos y cambia a la vista de Dashboard.
         */
        async function loginUser(email, password) {
            if (!db || !userId) return showMessage('Sistema no listo.', 'error');

            try {
                const userDocRef = doc(db, USERS_COLLECTION_PATH, email);
                const docSnap = await getDoc(userDocRef);

                if (!docSnap.exists()) {
                    showMessage('Usuario no encontrado o credenciales incorrectas.', 'error');
                    return false;
                }
                
                const userData = docSnap.data();

                // Simulaci贸n de validaci贸n de contrase帽a
                if (userData.simulatedPasswordHash !== password.length) {
                    showMessage('Contrase帽a incorrecta.', 'error');
                    return false;
                }

                // xito: Guardamos el email para futuras operaciones y cargamos la vista
                userEmail = email; 
                startBalanceListener(email); //  Iniciar la escucha en tiempo real
                switchView(true);
                showMessage(`隆Bienvenido, ${userData.username}!`, 'success');
                return true;

            } catch (error) {
                console.error("Error al iniciar sesi贸n y cargar datos:", error);
                showMessage(`Error de inicio de sesi贸n: ${error.message}`, 'error');
                return false;
            }
        }
        
        /**
         * Simula un cambio en el saldo del usuario (Juego o Dep贸sito).
         * @param {number} amount - Cantidad a sumar o restar.
         */
        async function updateBalance(amount) {
            if (!db || !userEmail) return showMessage('No hay usuario activo para actualizar.', 'error');

            try {
                const userDocRef = doc(db, USERS_COLLECTION_PATH, userEmail);

                // Usamos updateDoc para modificar un campo existente
                // Nota: Firestore permite hacer operaciones at贸micas para incrementar/decrementar,
                // pero aqu铆 hacemos una lectura y escritura simple por simplicidad.
                
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) return;
                
                const currentBalance = docSnap.data().balance || 0;
                const newBalance = currentBalance + amount;

                if (newBalance < 0) {
                     return showMessage('Saldo insuficiente para esta operaci贸n.', 'error');
                }

                await updateDoc(userDocRef, {
                    balance: newBalance,
                    lastUpdate: new Date().toISOString()
                });

                // La interfaz se actualizar谩 autom谩ticamente gracias a onSnapshot!
                if (amount < 0) {
                     showMessage(`隆Juego simulado! Has apostado $${Math.abs(amount).toFixed(2)}.`, 'info');
                } else {
                     showMessage(`隆Dep贸sito simulado exitoso de $${amount.toFixed(2)}!`, 'success');
                }

            } catch (error) {
                console.error("Error al actualizar el saldo:", error);
                showMessage(`Error al actualizar saldo: ${error.message}`, 'error');
            }
        }
        
        // --- Manejadores de Eventos ---

        logoutBtn.addEventListener('click', async () => {
            if (unsubscribeBalance) {
                unsubscribeBalance(); // Detener la escucha de Firestore
                unsubscribeBalance = null;
            }
            userEmail = null;
            await signOut(auth); // Cerrar sesi贸n de Firebase Auth (an贸nima)
            switchView(false); // Volver a la vista de autenticaci贸n
            showMessage("Sesi贸n cerrada correctamente.", 'info');
        });

        // Manejador de registro
        registerForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const btn = document.getElementById('register-btn');
            
            // 1. Deshabilitar inmediatamente el bot贸n y mostrar el estado de carga
            btn.disabled = true;
            btn.classList.add('disabled-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 mt-1"></i> Registrando...';

            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            try {
                if (password.length < 6) {
                    showMessage('La contrase帽a debe tener al menos 6 caracteres.', 'error');
                    return; // Detener la funci贸n aqu铆 si la validaci贸n falla
                }
                
                // 2. Intentar el registro en Firestore
                const success = await registerUser(username, email, password);

                if (success) {
                    toggleAuthView(); 
                }
            } catch (error) {
                console.error("Error durante el proceso de registro:", error);
                showMessage(`Error desconocido: ${error.message}`, 'error');
            } finally {
                // 3. Restaurar el bot贸n SIEMPRE al final
                btn.disabled = false;
                btn.classList.remove('disabled-btn');
                btn.innerHTML = '<i class="fas fa-user-plus mr-2 mt-1"></i> Registrarse';
            }
        });

        // Manejador de inicio de sesi贸n
        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const btn = document.getElementById('login-btn');
            btn.disabled = true;
            btn.classList.add('disabled-btn');

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            await loginUser(email, password);
            
            btn.disabled = false;
            btn.classList.remove('disabled-btn');
        });
        
        // Manejador de simulaci贸n de juego: restar $10
        simulateGameBtn.addEventListener('click', () => {
            updateBalance(-10);
        });
        
        // Manejador de simulaci贸n de dep贸sito: sumar $50
        simulateDepositBtn.addEventListener('click', () => {
            updateBalance(50);
        });
        
        // Listener de evento para el enlace de alternar
        toggleLink.addEventListener('click', toggleAuthView);

        // Iniciar Firebase al cargar el script
        // Deshabilitar botones inicialmente hasta que Firebase est茅 listo
        document.getElementById('login-btn').disabled = true;
        document.getElementById('register-btn').disabled = true;
        initializeFirebase();

    </script>
</body>
</html>